{% extends "base.html" %}

{% block title %}{{ field.title }}{% endblock %}

{% block content %}
<div class="card">
    <a href="/" class="home-button">üè† –î–æ–º–æ–π</a>
    <h1>{{ field.title }}</h1>
    <p>{{ field.description }}</p>

    <!-- –î–æ–±–∞–≤–ª–µ–Ω–Ω–∞—è —Å–µ–∫—Ü–∏—è —Å –∫–∞—Ä—Ç–æ–π -->
    <div class="map-container">
        <h3>Robot Map</h3>
        <div class="map-controls">
            <label>Grid Size:
                <input type="number" id="grid-x" value="5" min="3" max="10"> x
                <input type="number" id="grid-y" value="5" min="3" max="10">
                <button id="update-grid">Update Grid</button>
            </label>
        </div>
        <div class="map-grid" id="map-grid"></div>
    </div>

    <div class="actions">
        <button id="like-btn" class="like-btn {% if is_liked %}liked{% endif %}"
                data-field-id="{{ field.id }}">
            ‚ù§Ô∏è Like (<span id="likes-count">{{ field.likes.count }}</span>)
        </button>

        <button id="favorite-btn" class="favorite-btn {% if is_favorited %}favorited{% endif %}"
                data-field-id="{{ field.id }}">
            ‚≠ê Favorite
        </button>
    </div>

    <!-- –°–µ–∫—Ü–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
    <div class="comments-section">
        <h3>Comments</h3>

        <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
        <div class="comment-form">
            <textarea id="comment-text" class="comment-input" placeholder="Write your comment..."></textarea>
            <button id="submit-comment" class="submit-comment" data-field-id="{{ field.id }}">Post Comment</button>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
        <div class="comments-list" id="comments-list">
            {% for comment in field.comments.all %}
            <div class="comment" data-comment-id="{{ comment.id }}">
                <div class="comment-author">{{ comment.author.username }}</div>
                <div class="comment-text">{{ comment.text }}</div>
                <div class="comment-date">{{ comment.created_at|date:"Y-m-d H:i" }}</div>

                <div class="comment-actions">
                    <button class="comment-like-btn {% if request.user in comment.likes.all %}liked{% endif %}"
                            data-comment-id="{{ comment.id }}">
                        üëç Like (<span class="likes-count">{{ comment.likes.count }}</span>)
                    </button>

                    <button class="comment-report-btn" data-comment-id="{{ comment.id }}">
                        ‚ö†Ô∏è Report (<span class="reports-count">{{ comment.reports.count }}</span>)
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<style>
    .card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        max-width: 800px; /* –£–≤–µ–ª–∏—á–∏–ª –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É */
        margin: 20px auto;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .actions {
        display: flex;
        gap: 15px;
        margin-top: 15px;
    }
    .like-btn, .favorite-btn {
        cursor: pointer;
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        background: #f0f0f0;
    }
    .like-btn.liked {
        background: #ffcccc;
    }
    .favorite-btn.favorited {
        background: #ffffcc;
    }
    .comments-section {
        margin-top: 30px;
        border-top: 1px solid #eee;
        padding-top: 20px;
    }
    .comment-form {
        margin-bottom: 20px;
    }
    .comment-input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 10px;
    }
    .submit-comment {
        padding: 8px 15px;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    .comments-list {
        margin-top: 20px;
    }
    .comment {
        padding: 10px;
        border-bottom: 1px solid #eee;
        margin-bottom: 10px;
    }
    .comment-author {
        font-weight: bold;
        margin-bottom: 5px;
    }
    .comment-text {
        margin-bottom: 5px;
    }
    .comment-date {
        font-size: 0.8em;
        color: #777;
    }
    .comment-actions {
        margin-top: 10px;
        display: flex;
        gap: 10px;
    }
    .comment-like-btn, .comment-report-btn {
        padding: 3px 8px;
        border: none;
        border-radius: 4px;
        background: #f0f0f0;
        cursor: pointer;
        font-size: 0.9em;
    }
    .comment-like-btn.liked {
        background: #ccffcc;
    }
    .comment-report-btn {
        background: #ffe6e6;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç—ã */
    .map-container {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #f9f9f9;
    }
    .map-controls {
        margin-bottom: 15px;
    }
    .map-controls input {
        width: 40px;
        padding: 5px;
        margin: 0 5px;
    }
    .map-controls button {
        padding: 5px 10px;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    .map-grid {
        display: grid;
        gap: 2px;
        background-color: #333;
        padding: 2px;
        border: 2px solid #333;
        border-radius: 4px;
    }
    .cell {
        background-color: white;
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        position: relative;
    }
    .cell.wall {
        background-color: #555;
    }
    .cell.robot::after {
        content: "ü§ñ";
        font-size: 20px;
    }
    .cell.target::after {
        content: "‚≠ê";
        font-size: 20px;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const likeBtn = document.getElementById('like-btn');
        const favoriteBtn = document.getElementById('favorite-btn');
        const submitCommentBtn = document.getElementById('submit-comment');
        const commentText = document.getElementById('comment-text');
        const commentsList = document.getElementById('comments-list');

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∫–∞—Ä—Ç—ã
        let gridX = 5; // –†–∞–∑–º–µ—Ä –ø–æ X (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å)
        let gridY = 5; // –†–∞–∑–º–µ—Ä –ø–æ Y (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å)
        let robotPosition = {x: 1, y: 1}; // –ü–æ–∑–∏—Ü–∏—è —Ä–æ–±–æ—Ç–∞
        let walls = [{x: 2, y: 1}, {x: 1, y: 3}, {x: 3, y: 3}]; // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å—Ç–µ–Ω
        let targetPosition = {x: 4, y: 4}; // –¶–µ–ª–µ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è

        const mapGrid = document.getElementById('map-grid');
        const gridXInput = document.getElementById('grid-x');
        const gridYInput = document.getElementById('grid-y');
        const updateGridBtn = document.getElementById('update-grid');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        function initMap() {
            // –û—á–∏—â–∞–µ–º –∫–∞—Ä—Ç—É
            mapGrid.innerHTML = '';

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã grid
            mapGrid.style.gridTemplateColumns = `repeat(${gridX}, 1fr)`;
            mapGrid.style.gridTemplateRows = `repeat(${gridY}, 1fr)`;

            // –°–æ–∑–¥–∞–µ–º –∫–ª–µ—Ç–∫–∏
            for (let y = 0; y < gridY; y++) {
                for (let x = 0; x < gridX; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.x = x;
                    cell.dataset.y = y;

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∫–ª–µ—Ç–∫–∞ —Å—Ç–µ–Ω–æ–π
                    if (walls.some(wall => wall.x === x && wall.y === y)) {
                        cell.classList.add('wall');
                    }

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –∑–¥–µ—Å—å —Ä–æ–±–æ—Ç
                    if (x === robotPosition.x && y === robotPosition.y) {
                        cell.classList.add('robot');
                    }

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∫–ª–µ—Ç–∫–∞ —Ü–µ–ª—å—é
                    if (x === targetPosition.x && y === targetPosition.y) {
                        cell.classList.add('target');
                    }

                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–µ–Ω
                    cell.addEventListener('click', function() {
                        const x = parseInt(this.dataset.x);
                        const y = parseInt(this.dataset.y);

                        // –ù–µ–ª—å–∑—è —Å–¥–µ–ª–∞—Ç—å —Å—Ç–µ–Ω–æ–π –∫–ª–µ—Ç–∫—É —Å —Ä–æ–±–æ—Ç–æ–º –∏–ª–∏ —Ü–µ–ª—å—é
                        if ((x === robotPosition.x && y === robotPosition.y) ||
                            (x === targetPosition.x && y === targetPosition.y)) {
                            return;
                        }

                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Å—Ç–µ–Ω–∞ –∑–¥–µ—Å—å
                        const wallIndex = walls.findIndex(wall => wall.x === x && wall.y === y);

                        if (wallIndex === -1) {
                            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–µ–Ω—É
                            walls.push({x, y});
                            this.classList.add('wall');
                        } else {
                            // –£–¥–∞–ª—è–µ–º —Å—Ç–µ–Ω—É
                            walls.splice(wallIndex, 1);
                            this.classList.remove('wall');
                        }
                    });

                    mapGrid.appendChild(cell);
                }
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ç–∫–∏
        if (updateGridBtn) {
            updateGridBtn.addEventListener('click', function() {
                const newX = parseInt(gridXInput.value);
                const newY = parseInt(gridYInput.value);

                if (newX >= 3 && newX <= 10 && newY >= 3 && newY <= 10) {
                    gridX = newX;
                    gridY = newY;

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ–±—ã —Ä–æ–±–æ—Ç –∏ —Ü–µ–ª—å –æ—Å—Ç–∞–≤–∞–ª–∏—Å—å –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–æ–≤–æ–π —Å–µ—Ç–∫–∏
                    if (robotPosition.x >= gridX) robotPosition.x = gridX - 1;
                    if (robotPosition.y >= gridY) robotPosition.y = gridY - 1;
                    if (targetPosition.x >= gridX) targetPosition.x = gridX - 1;
                    if (targetPosition.y >= gridY) targetPosition.y = gridY - 1;

                    // –§–∏–ª—å—Ç—Ä—É–µ–º —Å—Ç–µ–Ω—ã, —á—Ç–æ–±—ã –æ–Ω–∏ –æ—Å—Ç–∞–≤–∞–ª–∏—Å—å –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö
                    walls = walls.filter(wall => wall.x < gridX && wall.y < gridY);

                    initMap();
                } else {
                    alert('Grid size must be between 3 and 10');
                }
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        initMap();

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏
        if (likeBtn) {
            likeBtn.addEventListener('click', function() {
                const fieldId = this.getAttribute('data-field-id');
                toggleLike(fieldId);
            });
        }

        if (favoriteBtn) {
            favoriteBtn.addEventListener('click', function() {
                const fieldId = this.getAttribute('data-field-id');
                toggleFavorite(fieldId);
            });
        }

        if (submitCommentBtn) {
            submitCommentBtn.addEventListener('click', function() {
                const fieldId = this.getAttribute('data-field-id');
                const text = commentText.value.trim();

                if (text) {
                    addComment(fieldId, text);
                }
            });
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
        document.querySelectorAll('.comment-like-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const commentId = this.getAttribute('data-comment-id');
                toggleCommentLike(commentId);
            });
        });

        document.querySelectorAll('.comment-report-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const commentId = this.getAttribute('data-comment-id');
                reportComment(commentId);
            });
        });

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏
        function toggleLike(fieldId) {
            fetch(`/cards/${fieldId}/toggle-like/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.is_liked !== undefined) {
                    likeBtn.classList.toggle('liked', data.is_liked);
                    document.getElementById('likes-count').textContent = data.likes_count;
                } else {
                    window.location.href = '/accounts/login/?next=' + window.location.pathname;
                }
            });
        }

        function toggleFavorite(fieldId) {
            fetch(`/cards/${fieldId}/toggle-favorite/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.is_favorited !== undefined) {
                    favoriteBtn.classList.toggle('favorited', data.is_favorited);
                } else {
                    window.location.href = '/accounts/login/?next=' + window.location.pathname;
                }
            });
        }

        function addComment(fieldId, text) {
            fetch(`/cards/${fieldId}/add-comment/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({text: text}),
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    commentText.value = '';

                    const commentDiv = document.createElement('div');
                    commentDiv.className = 'comment';
                    commentDiv.setAttribute('data-comment-id', data.comment_id);
                    commentDiv.innerHTML = `
                        <div class="comment-author">${data.author}</div>
                        <div class="comment-text">${data.text}</div>
                        <div class="comment-date">${data.created_at}</div>
                        <div class="comment-actions">
                            <button class="comment-like-btn" data-comment-id="${data.comment_id}">
                                üëç Like (<span class="likes-count">0</span>)
                            </button>
                            <button class="comment-report-btn" data-comment-id="${data.comment_id}">
                                ‚ö†Ô∏è Report (<span class="reports-count">0</span>)
                            </button>
                        </div>
                    `;

                    commentsList.insertBefore(commentDiv, commentsList.firstChild);

                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –Ω–æ–≤—ã—Ö –∫–Ω–æ–ø–æ–∫
                    commentDiv.querySelector('.comment-like-btn').addEventListener('click', function() {
                        toggleCommentLike(this.getAttribute('data-comment-id'));
                    });

                    commentDiv.querySelector('.comment-report-btn').addEventListener('click', function() {
                        reportComment(this.getAttribute('data-comment-id'));
                    });
                }
            });
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
        function toggleCommentLike(commentId) {
            fetch(`/comments/${commentId}/toggle-like/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const btn = document.querySelector(`.comment-like-btn[data-comment-id="${commentId}"]`);
                    const countSpan = btn.querySelector('.likes-count');

                    btn.classList.toggle('liked', data.is_liked);
                    countSpan.textContent = data.likes_count;
                } else if (data.redirect) {
                    window.location.href = '/accounts/login/?next=' + window.location.pathname;
                }
            });
        }

        function reportComment(commentId) {
            fetch(`/comments/${commentId}/report/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const btn = document.querySelector(`.comment-report-btn[data-comment-id="${commentId}"]`);
                    const countSpan = btn.querySelector('.reports-count');

                    countSpan.textContent = data.reports_count;
                    alert('Thank you for your report! We will review this comment.');
                } else if (data.redirect) {
                    window.location.href = '/accounts/login/?next=' + window.location.pathname;
                }
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
{% endblock %}